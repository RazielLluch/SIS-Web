{% extends "./layouts/master_layout.html" %}

{% block title %} {{ title }} {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/students.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/crud_buttons.css') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    header { flex: 1; }
    .content { flex: 1; height: 100%; display: flex; flex-direction: column; justify-content: center; padding: 0 50px 50px 50px; }
    table { width: 100%; border-collapse: collapse; }
    table th, table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    table .actions { border: 1px solid #ddd; padding: 0; width: 1%; white-space: nowrap; }
    table thead { background-color: #f2f2f2; }
    tr:hover { background-color: #f1f1f1; transition: background-color 0.3s ease; }
    .photo-thumbnail { border-radius: 100%; background: lightgray; }
    .photo-enlarged { display: none; position: absolute; border-radius: 100%; background: lightgray; z-index: 10; top: 0; left: 0; }
    .photo-container { position: relative; display: inline-block; margin-right: 10px; }
    .photo-container:hover .photo-enlarged { display: block; }
    .photo-container .photo-thumbnail { width: 50px; height: 50px; }
    .photo-container .photo-enlarged img { width: 170px; height: 170px; border-radius: 100%; background: lightgray; object-fit: cover; }
    .profile-picture-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
    }

    .profile-pic-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .profile-preview {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #ccc;
        transition: transform 0.2s ease-in-out;
        cursor: pointer;
    }

    .profile-preview:hover {
        transform: scale(2.5);
        border-color: #007bff;
        z-index: 10;
    }

</style>
{% endblock %}

{% block content %}
<div class="content">

    <!-- Flash Message Modal -->
    <div class="modal fade" id="flashMessageModal" tabindex="-1" aria-labelledby="flashMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="flashMessageModalLabel">Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% with messages = get_flashed_messages() %}
                    {% if messages %}
                    {% for message in messages %}
                    <p>{{ message }}</p>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search + Add Button -->
    {% set layout_type = "students" %}
    {% include 'layouts/crud_buttons.html' %}

    <!-- Students Table -->
    <div class="table-container">
        <table id="studentsTable">
            <thead>
            <tr>
                <th>Id</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Course</th>
                <th>Year</th>
                <th>Gender</th>
                <th class="actions">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for student in students %}
            {% include 'layouts/students/student_row.html' %}
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
        {% if page > 1 %}
        <a href="{{ url_for('students.index', page=page-1, search=request.args.get('search', '')) }}" class="page-link">Previous</a>
        {% endif %}
        {% if page > 3 %}
        <a href="{{ url_for('students.index', page=1) }}" class="page-link">1</a>
        <span class="page-ellipsis">...</span>
        {% endif %}
        {% for i in range(page - 2, page + 3) %}
        {% if i > 0 and i <= total_pages %}
        <a href="{{ url_for('students.index', page=i) }}" class="page-link {% if i == page %}active{% endif %}">{{ i }}</a>
        {% endif %}
        {% endfor %}
        {% if page < total_pages - 2 %}
        <span class="page-ellipsis">...</span>
        <a href="{{ url_for('students.index', page=total_pages) }}" class="page-link">{{ total_pages }}</a>
        {% endif %}
        {% if page < total_pages %}
        <a href="{{ url_for('students.index', page=page+1) }}" class="page-link">Next</a>
        {% endif %}
    </div>

    <!-- Add Modal -->
    {% include 'layouts/crud_modals/add_modal.html' %}

    <!-- Edit Modal -->
    {% include 'layouts/crud_modals/edit_modal.html' %}

    <!-- Delete Modal -->
    {% set delete_modal_type = "student" %}
    {% include 'layouts/crud_modals/delete_modal.html' %}

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const flashMessagesExist = {{ (get_flashed_messages()|length > 0)|tojson }};
        if (flashMessagesExist) {
            new bootstrap.Modal(document.getElementById('flashMessageModal')).show();
        }

        const deleteModal = new bootstrap.Modal(document.getElementById("deleteModal"));
        const deleteForm= document.getElementById("deleteStudentForm");
        const addStudentForm = document.getElementById("addStudentForm");
        const editStudentForm = document.getElementById("editStudentForm");
        const studentIdsField = document.getElementById("studentIds");

        // Populate course list when Add is clicked
        document.getElementById("addButton").addEventListener("click", async function() {
            const res = await fetch('/courses/get');
            if (res.ok) {
                const courses = await res.json();
                const courseSelect = document.getElementById("add_course");
                courseSelect.innerHTML = `<option value="" disabled selected>Select Course</option>`;
                courses.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c.id;
                    opt.textContent = c.id;
                    courseSelect.appendChild(opt);
                });
            }
            addStudentForm.action = `/students/add`;
        });

        // Edit button click
        document.querySelectorAll(".edit-btn").forEach(btn => {
            btn.addEventListener("click", async function() {
                const row = this.closest("tr");
                const studentId = row.dataset.studentId;
                document.getElementById("edit_student_id").value = studentId;
                document.getElementById("edit_firstname").value = row.dataset.firstname;
                document.getElementById("edit_lastname").value = row.dataset.lastname;
                document.getElementById("edit_year").value = row.dataset.year;
                document.getElementById("edit_gender").value = row.dataset.gender;

                const res = await fetch('/courses/get');
                if (res.ok) {
                    const courses = await res.json();
                    const courseSelect = document.getElementById("edit_course");
                    courseSelect.innerHTML = `<option value="" disabled>Select Course</option>`;
                    courses.forEach(c => {
                        const opt = document.createElement("option");
                        opt.value = c.id;
                        opt.textContent = c.id;
                        if (c.id === row.dataset.course) opt.selected = true;
                        courseSelect.appendChild(opt);
                    });
                }

                editStudentForm.action = `/students/edit/${studentId}`;
            });
        });

        const deleteIdsInput = document.getElementById("studentIds");

        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                const row = this.closest("tr");
                const studentId = row.dataset.studentId;

                deleteIdsInput.value = JSON.stringify([studentId]); // send as array
                deleteForm.addEventListener("submit", async function (e) {
                    e.preventDefault(); // stop normal form POST

                    const res = await fetch("/students/delete", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ student_ids: JSON.parse(deleteIdsInput.value) })
                    });

                    if (res.ok) {
                        const data = await res.json();
                        console.log(data);
                        // Optionally refresh table or remove deleted row from DOM
                        location.reload();
                    }
                });


                deleteModal.show();
            });
        });

    });
</script>
{% endblock %}
