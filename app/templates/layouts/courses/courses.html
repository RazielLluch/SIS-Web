{% extends "./layouts/master_layout.html" %}

{% block title %} {{ title }} {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/students.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/crud_buttons.css') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    header { flex: 1; }
    .content { flex: 1; height: 100%; display: flex; flex-direction: column; justify-content: center; padding: 0 50px 50px 50px; }
    table { width: 100%; border-collapse: collapse; }
    table th, table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    table .actions { border: 1px solid #ddd; padding: 0; width: 1%; white-space: nowrap; }
    table thead { background-color: #f2f2f2; }
    tr:hover { background-color: #f1f1f1; transition: background-color 0.3s ease; }
    .photo-thumbnail { border-radius: 100%; background: lightgray; }
    .photo-enlarged { display: none; position: absolute; border-radius: 100%; background: lightgray; z-index: 10; top: 0; left: 0; }
    .photo-container { position: relative; display: inline-block; margin-right: 10px; }
    .photo-container:hover .photo-enlarged { display: block; }
    .photo-container .photo-thumbnail { width: 50px; height: 50px; }
    .photo-container .photo-enlarged img { width: 170px; height: 170px; border-radius: 100%; background: lightgray; object-fit: cover; }
    .profile-picture-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
    }

    .profile-pic-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .profile-preview {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #ccc;
        transition: transform 0.2s ease-in-out;
        cursor: pointer;
    }

    .profile-preview:hover {
        transform: scale(2.5);
        border-color: #007bff;
        z-index: 10;
    }

</style>
{% endblock %}

{% block content %}
<div class="content">

    <!-- Flash Message Modal -->
    <div class="modal fade" id="flashMessageModal" tabindex="-1" aria-labelledby="flashMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="flashMessageModalLabel">Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% with messages = get_flashed_messages() %}
                    {% if messages %}
                    {% for message in messages %}
                    <p>{{ message }}</p>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    {% set layout_type = "courses" %}
    {% include 'layouts/crud_buttons.html' %}

    <div class="table-container">
        <table  id="coursesTable">
            <thead>
            <tr>
                <th>Course ID</th>
                <th>Course Name</th>
                <th>College</th>
                <th class="actions">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for course in courses %}
            {% include 'layouts/courses/course_row.html' %}
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Add Modal -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addModalLabel">Add Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCourseForm" method="POST">
                        <div class="mb-3">
                            <label for="add_course_id" class="form-label">Course ID</label>
                            <input type="text" class="form-control" id="add_course_id" name="course_id" required oninput="this.value = this.value.replace(/[^A-Za-z ]/g, '')"
>
                        </div>
                        <div class="mb-3">
                            <label for="add_coursename" class="form-label">Course Name</label>
                            <input type="text" class="form-control" id="add_coursename" name="coursename" required oninput="this.value = this.value.replace(/[^A-Za-z ]/g, '')"
>
                        </div>
                        <div class="mb-3">
                            <label for="add_college" class="form-label">College</label>
                            <select class="form-select" id="add_college" name="college" required>
                                <option value="" disabled selected>Select College</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Add Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCourseForm" method="POST">
                        <div class="mb-3">
                            <label for="edit_course_id" class="form-label">Course ID</label>
                            <input type="text" class="form-control" id="edit_course_id" name="course_id" required oninput="this.value = this.value.replace(/[^A-Za-z ]/g, '')"
>
                        </div>
                        <div class="mb-3">
                            <label for="edit_coursename" class="form-label">Course Name</label>
                            <input type="text" class="form-control" id="edit_coursename" name="course_name" required oninput="this.value = this.value.replace(/[^A-Za-z ]/g, '')"
>
                        </div>
                        <div class="mb-3">
                            <label for="edit_college" class="form-label">College</label>
                            <select class="form-select" id="edit_college" name="college" required>
                                <option value="" disabled selected>Select College</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Edit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    {% set delete_modal_type = "course" %}
    {% include 'layouts/crud_modals/delete_modal.html' %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const flashMessagesExist = {{ (get_flashed_messages()|length > 0)|tojson }};
        if (flashMessagesExist) {
            const flashMessageModal = new bootstrap.Modal(document.getElementById('flashMessageModal'));
            flashMessageModal.show();
        }
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {

        const deleteModal = new bootstrap.Modal(document.getElementById("deleteModal"));
        const deleteForm= document.getElementById("deleteCourseForm");
        const addStudentForm = document.getElementById("addCourseForm");
        const editCourseForm = document.getElementById("editCourseForm");
        const courseIdsField = document.getElementById("courseIds");

        // Populate course list when Add is clicked
        document.getElementById("addButton").addEventListener("click", async function() {
            const res = await fetch('/colleges/get');
            if (res.ok) {
                const courses = await res.json();
                const collegeSelect = document.getElementById("add_college");
                collegeSelect.innerHTML = `<option value="" disabled selected>Select College</option>`;
                courses.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c.id;
                    opt.textContent = c.id;
                    collegeSelect.appendChild(opt);
                });
            }
            addStudentForm.action = `/courses/add`;
        });

        // Edit button click
        document.querySelectorAll(".edit-btn").forEach(btn => {
            btn.addEventListener("click", async function() {
                const row = this.closest("tr");
                const courseId = row.dataset.courseId;
                document.getElementById("edit_course_id").value = courseId;
                document.getElementById("edit_coursename").value = row.dataset.courseName;

                const res = await fetch('/colleges/get');
                if (res.ok) {
                    const courses = await res.json();
                    const collegeSelect = document.getElementById("edit_college");
                    collegeSelect.innerHTML = `<option value="" disabled>Select College</option>`;
                    courses.forEach(c => {
                        const opt = document.createElement("option");
                        opt.value = c.id;
                        opt.textContent = c.id;
                        if (c.id === row.dataset.college) opt.selected = true;
                        collegeSelect.appendChild(opt);
                    });
                }

                editCourseForm.action = `/courses/edit/${courseId}`;
            });
        });

        const deleteIdsInput = document.getElementById("courseIds");

        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                const row = this.closest("tr");
                const courseId = row.dataset.courseId;

                deleteIdsInput.value = JSON.stringify([courseId]); // send as array
                deleteForm.addEventListener("submit", async function (e) {
                    e.preventDefault(); // stop normal form POST

                    const res = await fetch("/courses/delete", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ course_ids: JSON.parse(deleteIdsInput.value) })
                    });

                    if (res.ok) {
                        const data = await res.json();
                        location.reload();
                    } else {
                        const data = await res.json();
                        // Optional: don't reload so user can see the error
                    }
                });


                deleteModal.show();
            });
        });

    });
</script>
{% endblock %}
